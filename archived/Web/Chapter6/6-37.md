## PHP-FPM 提权

**PHP-FPM**（**FastCGI Process Manager**）是 PHP 的一种运行方式，专门用来提高 **PHP 在高并发 Web 环境中的性能和稳定性**

它负责 **管理多个 PHP 进程**，接收 Web 服务器（如 Nginx）发来的请求，交给 PHP 解析，然后把结果返回给 Web 服务器

```
用户浏览器
     ↓
   Nginx
     ↓ FastCGI（通过 Unix socket 或 TCP）
 PHP-FPM
     ↓
   PHP代码
```

配置文件位置

```bash
/etc/php/7.x/fpm/php-fpm.conf
/etc/php/7.x/fpm/pool.d/www.conf
```

正常的访问流程是：**浏览器 → Nginx（或 Apache） → PHP-FPM → 执行 PHP 文件**

如果我们知道 PHP-FPM 是监听在 **9000 端口**（默认），而且 Web 服务器没有加限制，那我们就可以**绕过 Nginx，直接用 FastCGI 协议和 FPM 通信**，就像模拟“Web 服务器”一样，直接让 FPM 执行 PHP 文件

前提条件如下：

**✅ 第一：你得指定一个“存在”的 PHP 文件（通过  `SCRIPT_FILENAME`）**

> 因为 FPM 接收请求时，需要你告诉它：要执行哪个 PHP 文件？

这就是 `SCRIPT_FILENAME` 参数的作用

- 如果这个参数指向的文件不存在，FPM 就直接返回 404
- 所以你必须找到目标服务器上已经存在的 PHP 文件

**💡技巧：**

> 有时候服务器上会预装一些 PHP 示例文件，攻击者可以利用这些

**✅ 第二：只能执行这个 PHP 文件？不能运行任意代码？**

就算你能控制  `SCRIPT_FILENAME`，也只能执行服务器上已有的 PHP 文件**

那如何实现“执行任意代码”呢？

> 可以利用 PHP 的配置项：`auto_prepend_file`。

**🚀 `auto_prepend_file` 是什么？**

这个配置项可以让你在执行目标 PHP 文件前，**自动包含（include）一个你指定的文件**

如果我们设置它为：`php://input`，那就表示——

> 在执行目标文件前，**先执行我们 POST 进来的 PHP 代码**！这就相当于远程执行了任意代码

**✅ 第三：PHP 默认禁止了这种用法，怎么办？**

PHP 有一个配置叫：

```ini
allow_url_include = Off
```

如果它是  `Off`，你就不能用  `php://input`  或远程 URL 做 include

**🤯 解决办法：**

FastCGI 协议里有两个关键字段：

- `PHP_VALUE`：设置普通的 php.ini 配置项
- `PHP_ADMIN_VALUE`：设置一些高级（受限制）的 php.ini 配置项

所以我们可以直接在 FastCGI 请求中设置：

```
PHP_VALUE: allow_url_include=On
```

再加上：

```
PHP_VALUE: auto_prepend_file=php://input
```

这样，PHP 就会在执行前**自动执行我们构造的 payload**，从而实现远程代码执行

在蚁剑中 FPM/FCGI 地址这里 localhost 和 127.0.0.1 都试一试

![](https://pic1.imgdb.cn/item/688197df58cb8da5c8d30a63.png)

连接新的木马

![](https://pic1.imgdb.cn/item/6881982e58cb8da5c8d30d34.png)
