## YARA 恶意软件检测

**YARA** = *Yet Another Ridiculous Acronym*

是一个用于 **恶意代码识别与分类** 的开源工具

通过编写 **规则（rule）** 来匹配文件或内存中的 **字符串、字节模式、正则表达式**

安全研究员常称它为 **恶意软件分析师的瑞士军刀**

```yara
rule test
{
    strings:
        $str1 = "UPX0" wide ascii
        $str2 = "AdjustTokenPrivileges" wide ascii
        $str3 = "LookupPrivilegeValueW" wide ascii

    condition:
        $str1 or ($str2 and $str3)
}
```

`rule test`

- 定义了一个规则，名字叫 **`test`**

- 当 YARA 扫描文件时，如果这个规则触发，就会输出：

  ```sh
  test suspicious.exe
  ```

这里定义了要匹配的字符串

- **`$str1 = "UPX0" wide ascii`**
  - 匹配文件中是否出现 `"UPX0"` 这个字符串
  - `ascii` = 普通 ASCII 字符串
  - `wide` = UTF-16LE 宽字节字符串
  - 也就是说，YARA 会同时匹配 `"UPX0"` 和 `"U\x00P\x00X\x000\x00"`
- **`$str2 = "AdjustTokenPrivileges" wide ascii`**
  - 匹配 Windows API 函数名 `"AdjustTokenPrivileges"`，通常用于修改进程权限
- **`$str3 = "LookupPrivilegeValueW" wide ascii`**
  - 匹配 API `"LookupPrivilegeValueW"`，常配合上一个 API 一起用来提升权限

`condition:` 部分

这是判断逻辑，决定什么时候触发

```yara
$str1 or ($str2 and $str3)
```

意思是：

- **情况 A**：文件里出现 `$str1`（即 `"UPX0"`）
- **情况 B**：文件里同时出现 `$str2` 和 `$str3`（即 `"AdjustTokenPrivileges"` + `"LookupPrivilegeValueW"`）

只要满足 **A 或 B**，这个规则就会触发

`"AdjustTokenPrivileges"` + `"LookupPrivilegeValueW"` → 这是 Windows 程序里典型的 **提权 API 组合**

开启终端会给出命令，匹配规则写入 `rules.txt `中

![](https://pic1.imgdb.cn/item/68a29d2258cb8da5c82c66a7.png)
