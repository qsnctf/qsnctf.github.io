## MongoDB 流量隐写

MongoDB 协议流程图如下

```
+-----------------+       +------------------+
|  Client         |       |  MongoDB Server  |
+-----------------+       +------------------+
| OP_MSG (find)   |  -->  |                  |
|                 |       | 执行查询         |
|                 |  <--  | OP_MSG (结果文档)|
+-----------------+       +------------------+
```

直接过滤 Mongo 协议

![](https://pic1.imgdb.cn/item/6882289258cb8da5c8d6a6fb.png)

细看流量包

![](https://pic1.imgdb.cn/item/688229f358cb8da5c8d6b761.png)

| 字段名               | 值           | 含义说明                                    |
| -------------------- | ------------ | ------------------------------------------- |
| `fullCollectionName` | `admin.$cmd` | 表示要操作的完整集合名（数据库名 + 集合名） |

`$cmd` 是 **MongoDB 的内部虚拟集合名**，代表“我要发送一个数据库命令”，而不是常规的 CRUD（增删改查）操作

![](https://pic1.imgdb.cn/item/68822a4c58cb8da5c8d6bcbd.png)

| 字段          | 意图                                        |
| ------------- | ------------------------------------------- |
| `ismaster`    | 请求服务器返回自身状态（已被 `hello` 取代） |
| `client`      | 提供客户端系统和驱动信息（诊断用途）        |
| `compression` | 提出支持的压缩协议（优化网络传输）          |

再来看对应的响应包

![](https://pic1.imgdb.cn/item/68822aa658cb8da5c8d6c2ea.png)

响应内容大致如下

```json
{
  "ismaster": true,
  "maxBsonObjectSize": 16777216,
  "maxMessageSizeBytes": 48000000,
  "maxWriteBatchSize": 100000,
  "localTime": "2025-07-24T12:34:56.123Z",
  "logicalSessionTimeoutMinutes": 30,
  "minWireVersion": 0,
  "maxWireVersion": 13,
  "readOnly": false,
  "ok": 1
}
```

| 字段名                         | 类型     | 说明                                          |
| ------------------------------ | -------- | --------------------------------------------- |
| `ismaster` / `hello`           | 布尔值   | 表示服务器是主节点（primary）                 |
| `maxBsonObjectSize`            | 整数     | 单个 BSON 文档的最大字节数（默认 16MB）       |
| `maxMessageSizeBytes`          | 整数     | 最大消息包大小（默认约 48MB）                 |
| `maxWriteBatchSize`            | 整数     | 批量写入的最大文档数（默认 100,000）          |
| `localTime`                    | 日期时间 | 服务器的本地时间（ISO8601 格式）              |
| `logicalSessionTimeoutMinutes` | 整数     | 逻辑会话超时时间，单位分钟                    |
| `minWireVersion`               | 整数     | 支持的协议版本范围下限                        |
| `maxWireVersion`               | 整数     | 支持的协议版本范围上限（13 对应 MongoDB 7.x） |
| `readOnly`                     | 布尔值   | 是否为只读实例（如只读副本或监控节点）        |
| `ok`                           | 数值     | 是否成功执行该命令（1 = 成功）                |

其具体的值在 Value 中查看

![](https://pic1.imgdb.cn/item/68822adb58cb8da5c8d6c677.png)
